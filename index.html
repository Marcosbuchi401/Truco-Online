<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
<title>Truco Online</title>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
<style>
*{box-sizing:border-box;margin:0;padding:0}
body{font-family:Georgia,serif;background:#1a5c2a;color:#fff;min-height:100vh;display:flex;flex-direction:column;align-items:center;justify-content:center;padding:10px}
.screen{display:none;width:100%;max-width:860px;padding:16px}
.screen.active{display:flex;flex-direction:column;align-items:center}
h1{font-size:2.4em;color:#f5d76e;text-shadow:2px 2px 4px #000;margin-bottom:6px}
h2{color:#f5d76e;font-size:1.5em;margin-bottom:12px}
.sub{color:#bbb;margin-bottom:20px;font-size:.9em}
.btn{padding:11px 24px;border:none;border-radius:8px;font-size:1em;font-family:Georgia;cursor:pointer;transition:all .2s}
.btn:disabled{opacity:.4;cursor:not-allowed}
.btn-gold{background:#f5d76e;color:#1a1a1a;font-weight:bold}
.btn-gold:hover:not(:disabled){background:#e8c44a;transform:scale(1.03)}
.btn-outline{background:transparent;color:#f5d76e;border:2px solid #f5d76e}
.btn-outline:hover:not(:disabled){background:#f5d76e22}
.btn-red{background:#c0392b;color:#fff}.btn-red:hover:not(:disabled){background:#a93226}
.btn-green{background:#27ae60;color:#fff}.btn-green:hover:not(:disabled){background:#1e8449}
.btn-gray{background:#445;color:#fff}.btn-gray:hover:not(:disabled){background:#334}
input{padding:10px 14px;border-radius:8px;border:2px solid #f5d76e;background:#0d3d18;color:#fff;font-size:1em;font-family:Georgia;outline:none;width:100%;max-width:280px}
input:focus{border-color:#fff}
label{color:#bbb;font-size:.88em;margin-bottom:4px;display:block}
.fg{margin:8px 0;text-align:left;width:100%;max-width:280px}
.status{color:#aaa;font-size:.85em;margin-top:10px;text-align:center;min-height:20px}
.lobby-box{background:#0d3d18;border:2px solid #2e7d45;border-radius:12px;padding:18px;width:100%;max-width:380px;text-align:center;margin-bottom:14px}
.code{font-size:2.2em;letter-spacing:5px;color:#f5d76e;font-weight:bold;margin:6px 0}
.slot{background:#1a5c2a;border:1px dashed #555;border-radius:8px;padding:9px 14px;margin:6px 0;font-size:1em}
.slot.ok{border:1px solid #27ae60;color:#7dff9a}
.score-bar{display:flex;justify-content:space-between;width:100%;background:#0d3d18;border-radius:10px;padding:7px 18px;font-size:.9em;margin-bottom:6px}
.score-bar span{color:#f5d76e;font-weight:bold}
.table{width:100%;background:#145c28;border-radius:18px;border:3px solid #2e7d45;padding:16px;display:flex;flex-direction:column;align-items:center;gap:10px;min-height:280px}
.area{display:flex;flex-direction:column;align-items:center;gap:6px;width:100%}
.aname{font-size:.82em;color:#aaa}
.myname{font-size:.82em;color:#7dff9a;font-weight:bold}
.card-row{display:flex;gap:8px;justify-content:center;flex-wrap:wrap}
.mid{display:flex;flex-direction:column;align-items:center;gap:6px;width:100%}
.dots{display:flex;gap:7px;justify-content:center}
.dot{width:13px;height:13px;border-radius:50%;border:2px solid #555}
.dot.me{background:#3498db;border-color:#3498db}
.dot.opp{background:#e74c3c;border-color:#e74c3c}
.dot.draw{background:#aaa;border-color:#aaa}
.played-row{display:flex;gap:18px;justify-content:center;align-items:center;min-height:95px}
.pspot{width:63px;height:90px;border:2px dashed #2e7d45;border-radius:8px;display:flex;align-items:center;justify-content:center;color:#2e7d45;font-size:.72em;flex-shrink:0}
.card{width:63px;height:90px;border-radius:8px;border:2px solid #8B6914;background:#fff;color:#222;display:flex;flex-direction:column;align-items:center;justify-content:center;transition:transform .15s,box-shadow .15s;user-select:none;flex-shrink:0}
.card.can{cursor:pointer}.card.can:hover{transform:translateY(-10px);box-shadow:0 8px 18px #0009}
.card.no{cursor:default}
.card.fd{background:#8B1A1A;border-color:#5a0d0d;cursor:default}
.card.fd::after{content:'ğŸ‚ ';font-size:1.8em;color:#f5d76e}
.card.sm{transform:scale(.82)}
.card .n{font-size:1.25em;font-weight:bold;line-height:1}
.card .s{font-size:1.3em;line-height:1}
.card.espada .s{color:#2c3e50}.card.basto .s{color:#27ae60}.card.oro .s{color:#d4ac0d}.card.copa .s{color:#c0392b}
.callbar{background:#0d3d18;border-radius:9px;padding:7px 14px;text-align:center;font-size:.88em;color:#f5d76e;min-height:34px;width:100%}
.actions{display:flex;gap:7px;flex-wrap:wrap;justify-content:center;width:100%}
.actions .btn{font-size:.82em;padding:7px 14px}
.log{width:100%;background:#0d3d18;border-radius:9px;padding:7px 12px;height:64px;overflow-y:auto;font-size:.75em;color:#aaa;margin-top:2px}
.log p{margin:2px 0}.log p.hi{color:#f5d76e}
#toast{position:fixed;bottom:24px;left:50%;transform:translateX(-50%);background:#f5d76e;color:#1a1a1a;padding:9px 22px;border-radius:18px;font-weight:bold;display:none;z-index:999}
.spin{display:inline-block;width:14px;height:14px;border:2px solid #f5d76e44;border-top-color:#f5d76e;border-radius:50%;animation:sp .7s linear infinite;vertical-align:middle;margin-right:5px}
@keyframes sp{to{transform:rotate(360deg)}}
@media(max-width:480px){
  .card{width:52px;height:75px}.card .n{font-size:1em}.card .s{font-size:1.1em}
  h1{font-size:1.9em}.pspot{width:52px;height:75px}
}
</style>
</head>
<body>

<div id="home" class="screen active">
  <h1>ğŸƒ Truco</h1>
  <p class="sub">JugÃ¡ al truco con tus amigos online</p>
  <div class="fg"><label>Tu apodo</label><input id="nick" type="text" placeholder="Ej: ElGaucho" maxlength="16"></div>
  <div style="margin-top:14px;display:flex;gap:10px;flex-wrap:wrap;justify-content:center">
    <button class="btn btn-gold" id="btn-create">Crear mesa</button>
    <button class="btn btn-outline" id="btn-toggle-join">Unirse a mesa</button>
  </div>
  <div id="join-area" style="display:none;margin-top:14px;text-align:center">
    <div class="fg" style="margin:0 auto 8px"><label>CÃ³digo de sala</label>
      <input id="join-code" type="text" placeholder="Ej: TRABCD" maxlength="8" style="text-transform:uppercase">
    </div>
    <button class="btn btn-gold" id="btn-join">Entrar</button>
  </div>
  <div id="home-st" class="status"></div>
</div>

<div id="lobby" class="screen">
  <h2>ğŸƒ Mesa de Truco</h2>
  <div class="lobby-box">
    <div style="font-size:.82em;color:#aaa;margin-bottom:4px">CompartÃ­ este cÃ³digo con tu amigo:</div>
    <div class="code" id="room-code">----</div>
    <button class="btn btn-outline" id="btn-copy" style="margin-top:8px;font-size:.78em;padding:5px 14px">ğŸ“‹ Copiar cÃ³digo</button>
  </div>
  <div style="width:100%;max-width:380px">
    <div id="slot-0" class="slot">Jugador 1: esperando...</div>
    <div id="slot-1" class="slot">Jugador 2: esperando...</div>
  </div>
  <div id="lobby-st" class="status"><span class="spin"></span>Esperando...</div>
  <button id="start-btn" class="btn btn-gold" style="margin-top:14px;display:none">â–¶ Empezar partida</button>
</div>

<div id="game" class="screen">
  <div class="score-bar">
    <div>Rival: <span id="sc-opp">0</span> pts</div>
    <div style="color:#aaa;font-size:.82em" id="rl">Mano 1</div>
    <div>Vos: <span id="sc-me">0</span> pts</div>
  </div>
  <div class="table">
    <div class="area"><div class="aname" id="opp-nm">Rival</div><div class="card-row" id="opp-cards"></div></div>
    <div class="mid"><div class="dots" id="rdots"></div><div class="played-row" id="played"></div></div>
    <div class="area"><div class="card-row" id="my-cards"></div><div class="myname" id="my-nm">Vos</div></div>
  </div>
  <div class="callbar" id="callbar">...</div>
  <div class="actions" id="acts"></div>
  <div class="log" id="log"></div>
</div>

<div id="toast"></div>

<script>
// â”€â”€ FIREBASE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
firebase.initializeApp({
  apiKey: "AIzaSyAn3FY_vgJo2UgM8LhbnGbdm7kGQyV2X-Y",
  authDomain: "truco-online-420.firebaseapp.com",
  databaseURL: "https://truco-online-420-default-rtdb.firebaseio.com",
  projectId: "truco-online-420",
  storageBucket: "truco-online-420.firebasestorage.app",
  messagingSenderId: "293273518282",
  appId: "1:293273518282:web:3096a99a622c0c7f857433"
});
var db = firebase.database();
var rr = function(code){ return db.ref('rooms/' + code); };

// â”€â”€ CONSTANTES â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
var SUITS = {e:{sym:'âš”ï¸',name:'espada'},b:{sym:'ğŸŒ¿',name:'basto'},o:{sym:'ğŸª™',name:'oro'},c:{sym:'ğŸ†',name:'copa'}};
var TO = ['1e','1b','7e','7o','3e','3b','3o','3c','2e','2b','2o','2c','1o','1c','12e','12b','12o','12c','11e','11b','11o','11c','10e','10b','10o','10c','4e','4b','4o','4c','5e','5b','5o','5c','6e','6b','6o','6c','7b','7c'];
var EN = ['','Envido','Envido+Envido','Real Envido','Falta Envido'];
var TN = ['','Truco','Retruco','Vale Cuatro'];

function tV(c){ var i=TO.indexOf(c.num+c.suit); return i<0?0:TO.length-i; }
function eP(c){ var n=parseInt(c.num); return n>=10?0:n; }
function calcEnv(cs){
  var m={};
  for(var i=0;i<cs.length;i++){var c=cs[i];if(!m[c.suit])m[c.suit]=[];m[c.suit].push(eP(c));}
  var b=0;
  for(var s in m){var p=m[s].sort(function(a,v){return v-a;});var v=p.length>=2?20+p[0]+p[1]:p[0];if(v>b)b=v;}
  return b;
}
function mkDeck(){
  var d=[];
  var suits=['e','b','o','c'];
  var nums=['1','2','3','4','5','6','7','10','11','12'];
  for(var i=0;i<suits.length;i++)for(var j=0;j<nums.length;j++)d.push({num:nums[j],suit:suits[i],id:nums[j]+suits[i]});
  return d;
}
function sfl(a){
  var arr=a.slice();
  for(var i=arr.length-1;i>0;i--){var j=Math.floor(Math.random()*(i+1));var t=arr[i];arr[i]=arr[j];arr[j]=t;}
  return arr;
}
function genCode(){
  var c='ABCDEFGHJKLMNPQRSTUVWXYZ23456789';
  var r='TR';
  for(var i=0;i<4;i++)r+=c[Math.floor(Math.random()*c.length)];
  return r;
}
function cloneGS(gs){ return JSON.parse(JSON.stringify(gs)); }

// â”€â”€ SESIÃ“N â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
var myNick='', myRole='', roomCode='', GS=null, roomListener=null;

// â”€â”€ BOTONES â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
document.getElementById('btn-create').onclick = createRoom;
document.getElementById('btn-toggle-join').onclick = toggleJoin;
document.getElementById('btn-join').onclick = joinRoom;
document.getElementById('btn-copy').onclick = copyCode;
document.getElementById('start-btn').onclick = hostStart;

// â”€â”€ SALA â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function createRoom(){
  myNick = document.getElementById('nick').value.trim();
  if(!myNick){toast('IngresÃ¡ tu apodo');return;}
  myRole = 'p1';
  roomCode = genCode();
  setSt('home','<span class="spin"></span>Creando sala...');
  rr(roomCode).set({p1Nick:myNick,p2Nick:null,started:false,gs:null,pendingAction:null}).then(function(){
    document.getElementById('room-code').textContent = roomCode;
    showScreen('lobby');
    setSlot(0,myNick,true); setSlot(1,null,false);
    setSt('lobby','<span class="spin"></span>Esperando que alguien se una...');
    listenRoom();
  }).catch(function(e){ setSt('home','âŒ Error: '+e.message); });
}

function toggleJoin(){
  var ja=document.getElementById('join-area');
  ja.style.display = ja.style.display==='none'?'block':'none';
}

function joinRoom(){
  myNick = document.getElementById('nick').value.trim();
  var code = document.getElementById('join-code').value.trim().toUpperCase();
  if(!myNick){toast('IngresÃ¡ tu apodo');return;}
  if(!code){toast('IngresÃ¡ el cÃ³digo');return;}
  setSt('home','<span class="spin"></span>Buscando sala...');
  rr(code).once('value').then(function(snap){
    var room=snap.val();
    if(!room){setSt('home','âŒ Sala no encontrada.');return;}
    if(room.p2Nick){setSt('home','âŒ La sala ya estÃ¡ llena.');return;}
    if(room.started){setSt('home','âŒ La partida ya empezÃ³.');return;}
    myRole='p2'; roomCode=code;
    return rr(code).update({p2Nick:myNick}).then(function(){
      document.getElementById('room-code').textContent = roomCode;
      showScreen('lobby');
      setSlot(0,room.p1Nick,false); setSlot(1,myNick,true);
      setSt('lobby','<span class="spin"></span>Esperando que el host empiece...');
      listenRoom();
    });
  }).catch(function(e){ setSt('home','âŒ Error: '+e.message); });
}

function listenRoom(){
  if(roomListener){ rr(roomCode).off('value',roomListener); }
  roomListener = rr(roomCode).on('value', function(snap){
    var room=snap.val();
    if(!room) return;

    if(!room.started){
      setSlot(0,room.p1Nick||'?',myRole==='p1');
      setSlot(1,room.p2Nick||null,myRole==='p2');
      if(room.p2Nick && myRole==='p1'){
        setSt('lobby','âœ… '+room.p2Nick+' se uniÃ³!');
        document.getElementById('start-btn').style.display='block';
      }
      return;
    }

    if(!room.gs) return;

    // Host procesa acciÃ³n pendiente del guest
    if(myRole==='p1' && room.pendingAction){
      var act=room.pendingAction;
      rr(roomCode).update({pendingAction:null});
      GS=cloneGS(room.gs);
      applyAction(act.role, act.action, act.data);
      rr(roomCode).update({gs:GS});
      showScreen('game');
      renderGame(viewFor(GS,'p1'));
      return;
    }

    GS=cloneGS(room.gs);
    showScreen('game');
    renderGame(viewFor(GS,myRole));
  });
}

function hostStart(){
  rr(roomCode).once('value').then(function(snap){
    var room=snap.val();
    if(!room||!room.p2Nick){toast('EsperÃ¡ que se una el otro jugador');return;}
    GS=newGS(room.p1Nick,room.p2Nick);
    rr(roomCode).update({started:true,gs:GS});
    showScreen('game');
    renderGame(viewFor(GS,'p1'));
  });
}

function doAction(action,data){
  if(!data) data={};
  if(myRole==='p1'){
    rr(roomCode).once('value').then(function(snap){
      GS=cloneGS(snap.val().gs);
      applyAction('p1',action,data);
      rr(roomCode).update({gs:GS});
      renderGame(viewFor(GS,'p1'));
    });
  } else {
    rr(roomCode).update({pendingAction:{role:'p2',action:action,data:data,ts:Date.now()}});
  }
}

// â”€â”€ LÃ“GICA DEL JUEGO â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function applyAction(role,action,data){
  if(!GS) return;
  var opp=role==='p1'?'p2':'p1';
  var me=GS[role], them=GS[opp];

  if(action==='PLAY_CARD'){
    if(GS.turn!==role||GS.phase!=='play') return;
    var idx=-1;
    for(var i=0;i<me.hand.length;i++){if(me.hand[i].id===data.id){idx=i;break;}}
    if(idx<0) return;
    var card=me.hand.splice(idx,1)[0];
    me.played.push({card:card,sub:GS.subRound});
    lg(me.nick+' jugÃ³ '+card.num+' de '+SUITS[card.suit].name);
    var mp=me.played.filter(function(p){return p.sub===GS.subRound;}).length>0;
    var tp=them.played.filter(function(p){return p.sub===GS.subRound;}).length>0;
    if(mp&&tp) resolveSubRound(); else GS.turn=opp;
    return;
  }
  if(action==='CALL_ENVIDO'){
    if(GS.phase!=='play'||GS.subRound>0) return;
    var es=GS.envi.state;
    if(es==='accepted'||es==='rejected') return;
    if(es==='called'&&GS.envi.caller===role) return;
    GS.envi={state:'called',caller:role,level:data.level,responder:opp};
    GS.phase='envi_resp'; GS.turn=opp;
    lg(me.nick+' cantÃ³ '+EN[data.level]+'!','hi'); return;
  }
  if(action==='RESP_ENVIDO'){
    if(GS.phase!=='envi_resp'||GS.envi.responder!==role) return;
    if(data.r==='quiero'){resolveEnvido();return;}
    if(data.r==='no_quiero'){
      var pm={1:1,2:2,3:2,4:1};
      GS[GS.envi.caller].score+=pm[GS.envi.level]||1;
      lg(me.nick+' no quiso. '+GS[GS.envi.caller].nick+' gana '+(pm[GS.envi.level]||1)+' pts.');
      GS.envi.state='rejected'; GS.phase='play'; recalcTurn(); checkWin(); return;
    }
    if(data.r==='raise'){
      GS.envi.level=data.level; GS.envi.caller=role; GS.envi.responder=opp; GS.turn=opp;
      lg(me.nick+' subiÃ³ a '+EN[data.level]+'!','hi'); return;
    }
  }
  if(action==='CALL_TRUCO'){
    if(GS.phase==='envi_resp') return;
    var ts=GS.truco.state;
    if(ts==='rejected'||GS.truco.level>=3) return;
    if(ts==='called'&&GS.truco.caller===role) return;
    GS.truco.level=ts==='none'?1:GS.truco.level+1;
    GS.truco.caller=role; GS.truco.state='called';
    GS.phase='truco_resp'; GS.turn=opp;
    lg(me.nick+' cantÃ³ '+TN[GS.truco.level]+'!','hi'); return;
  }
  if(action==='RESP_TRUCO'){
    if(GS.phase!=='truco_resp'||GS.truco.caller===role) return;
    if(data.r==='quiero'){
      GS.truco.state='accepted'; GS.phase='play';
      lg(me.nick+' quiero!'); recalcTurn(); return;
    }
    if(data.r==='no_quiero'){
      GS[GS.truco.caller].score+=GS.truco.level;
      lg(me.nick+' no quiso. '+GS[GS.truco.caller].nick+' gana '+GS.truco.level+' pts.');
      GS.truco.state='rejected'; checkWin();
      if(!GS.winner) scheduleNextHand(); else GS.phase='done'; return;
    }
    if(data.r==='raise'){applyAction(role,'CALL_TRUCO',{});return;}
  }
  if(action==='MAZO'){
    var pts=GS.truco.state==='accepted'?[0,2,3,4][GS.truco.level]:1;
    them.score+=pts;
    lg(me.nick+' se fue al mazo. '+them.nick+' gana '+pts+' pts.');
    checkWin(); if(!GS.winner) scheduleNextHand(); else GS.phase='done'; return;
  }
  if(action==='NEW_GAME'){GS=newGS(GS.p1.nick,GS.p2.nick);return;}
  if(action==='NEXT_HAND'){nextHand();return;}
}

function scheduleNextHand(){
  GS.phase='done_hand';
  setTimeout(function(){
    if(myRole!=='p1') return;
    rr(roomCode).once('value').then(function(snap){
      var room=snap.val();
      if(!room||!room.gs) return;
      GS=cloneGS(room.gs);
      if(GS.phase==='done_hand'&&!GS.winner){
        nextHand();
        rr(roomCode).update({gs:GS});
      }
    });
  },2000);
}

function resolveSubRound(){
  var p1p=null,p2p=null;
  for(var i=0;i<GS.p1.played.length;i++){if(GS.p1.played[i].sub===GS.subRound){p1p=GS.p1.played[i];break;}}
  for(var i=0;i<GS.p2.played.length;i++){if(GS.p2.played[i].sub===GS.subRound){p2p=GS.p2.played[i];break;}}
  var v1=tV(p1p.card),v2=tV(p2p.card);
  var rw=v1>v2?'p1':v2>v1?'p2':'draw';
  GS.rounds.push(rw);
  lg('Vuelta '+(GS.subRound+1)+': '+GS.p1.nick+'('+p1p.card.num+p1p.card.suit+') vs '+GS.p2.nick+'('+p2p.card.num+p2p.card.suit+') â†’ '+(rw==='draw'?'Empate':GS[rw].nick));
  var hw=handWinner();
  if(hw!==null||GS.subRound>=2) resolveHand(hw);
  else{GS.subRound++;GS.turn=rw==='draw'?GS.manoOwner:rw;}
}
function resolveHand(hw){
  var pts=GS.truco.state==='accepted'?[0,2,3,4][GS.truco.level]:1;
  var winner=hw||GS.manoOwner;
  GS[winner].score+=pts;
  lg('Mano para '+GS[winner].nick+'! +'+pts+' pts.','hi');
  checkWin(); if(!GS.winner) scheduleNextHand(); else GS.phase='done';
}
function resolveEnvido(){
  var a1=GS.p1.hand.concat(GS.p1.played.map(function(p){return p.card;}));
  var a2=GS.p2.hand.concat(GS.p2.played.map(function(p){return p.card;}));
  var v1=calcEnv(a1),v2=calcEnv(a2);
  var pts;
  if(GS.envi.level===4){var loser=v1>=v2?'p2':'p1';pts=Math.max(1,30-GS[loser].score);}
  else{var pm={1:2,2:4,3:3};pts=pm[GS.envi.level]||2;}
  var w=v1>=v2?'p1':'p2';
  GS[w].score+=pts; GS.envi.state='accepted';
  lg('Envido: '+GS.p1.nick+'='+v1+' vs '+GS.p2.nick+'='+v2+'. Gana '+GS[w].nick+' +'+pts+' pts.','hi');
  GS.phase='play'; recalcTurn(); checkWin();
}
function handWinner(){
  var w={p1:0,p2:0};
  for(var i=0;i<GS.rounds.length;i++){if(GS.rounds[i]!=='draw')w[GS.rounds[i]]++;}
  if(w.p1>=2)return'p1'; if(w.p2>=2)return'p2';
  if(GS.rounds.length>=2&&GS.rounds[0]==='draw'&&GS.rounds[1]!=='draw')return GS.rounds[1];
  if(GS.rounds.length===3&&GS.rounds[0]==='draw'&&GS.rounds[1]==='draw'&&GS.rounds[2]==='draw')return GS.manoOwner;
  return null;
}
function checkWin(){if(GS.p1.score>=30&&!GS.winner)GS.winner='p1';if(GS.p2.score>=30&&!GS.winner)GS.winner='p2';}
function recalcTurn(){
  if(!GS.rounds.length){GS.turn=GS.manoOwner;return;}
  var l=GS.rounds[GS.rounds.length-1];
  GS.turn=l==='draw'?GS.manoOwner:l;
}
function nextHand(){
  var d=sfl(mkDeck());
  GS.manoOwner=GS.manoOwner==='p1'?'p2':'p1';
  GS.p1.hand=d.slice(0,3).map(function(c){return{num:c.num,suit:c.suit,id:c.id};});
  GS.p2.hand=d.slice(3,6).map(function(c){return{num:c.num,suit:c.suit,id:c.id};});
  GS.p1.played=[]; GS.p2.played=[]; GS.subRound=0; GS.rounds=[];
  GS.envi={state:'none',caller:null,level:0,responder:null};
  GS.truco={state:'none',caller:null,level:0};
  GS.phase='play'; GS.turn=GS.manoOwner;
  GS.handNum=(GS.handNum||1)+1; GS.winner=null;
}
function newGS(p1,p2){
  var d=sfl(mkDeck());
  return{
    p1:{nick:p1,hand:d.slice(0,3).map(function(c){return{num:c.num,suit:c.suit,id:c.id};}),played:[],score:0},
    p2:{nick:p2,hand:d.slice(3,6).map(function(c){return{num:c.num,suit:c.suit,id:c.id};}),played:[],score:0},
    manoOwner:'p1',turn:'p1',subRound:0,rounds:[],
    envi:{state:'none',caller:null,level:0,responder:null},
    truco:{state:'none',caller:null,level:0},
    phase:'play',handNum:1,winner:null
  };
}
function viewFor(gs,role){
  var v=cloneGS(gs);
  var opp=role==='p1'?'p2':'p1';
  v[opp].hand=v[opp].hand.map(function(c){return{num:c.num,suit:c.suit,id:c.id,hidden:true};});
  v.myRole=role; return v;
}

// â”€â”€ RENDER â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function renderGame(gs){
  if(!gs) return;
  var mr=gs.myRole, or=mr==='p1'?'p2':'p1';
  var me=gs[mr], opp=gs[or], isMt=gs.turn===mr;

  document.getElementById('sc-me').textContent=me.score;
  document.getElementById('sc-opp').textContent=opp.score;
  document.getElementById('rl').textContent='Mano '+(gs.handNum||1)+' Â· Vuelta '+(gs.subRound+1);
  document.getElementById('opp-nm').textContent=opp.nick;
  document.getElementById('my-nm').textContent=me.nick+(isMt&&gs.phase==='play'?' ğŸ´':'');

  var de=document.getElementById('rdots'); de.innerHTML='';
  for(var i=0;i<3;i++){
    var d=document.createElement('div'); d.className='dot';
    if(gs.rounds[i]){if(gs.rounds[i]===mr)d.classList.add('me');else if(gs.rounds[i]===or)d.classList.add('opp');else d.classList.add('draw');}
    de.appendChild(d);
  }

  var pe=document.getElementById('played'); pe.innerHTML='';
  var mp=null,op=null;
  for(var i=0;i<me.played.length;i++){if(me.played[i].sub===gs.subRound){mp=me.played[i];break;}}
  for(var i=0;i<opp.played.length;i++){if(opp.played[i].sub===gs.subRound){op=opp.played[i];break;}}
  pe.appendChild(mkSpot(op,'rival'));
  pe.appendChild(mkSpot(mp,'yo'));

  var oc=document.getElementById('opp-cards'); oc.innerHTML='';
  for(var i=0;i<opp.hand.length;i++) oc.appendChild(mkCard(opp.hand[i],false,true));

  var mc=document.getElementById('my-cards'); mc.innerHTML='';
  var canPlay=isMt&&gs.phase==='play';
  for(var i=0;i<me.hand.length;i++){
    (function(card){
      var el=mkCard(card,!canPlay,false);
      if(canPlay){el.classList.add('can');el.onclick=function(){doAction('PLAY_CARD',{id:card.id});};}
      else el.classList.add('no');
      mc.appendChild(el);
    })(me.hand[i]);
  }

  var cb=document.getElementById('callbar');
  if(gs.phase==='envi_resp') cb.textContent=gs[gs.envi.caller].nick+' cantÃ³ '+EN[gs.envi.level]+'!';
  else if(gs.phase==='truco_resp') cb.textContent=gs[gs.truco.caller].nick+' cantÃ³ '+TN[gs.truco.level]+'!';
  else if(gs.phase==='done'&&gs.winner) cb.textContent='ğŸ† Â¡'+gs[gs.winner].nick+' ganÃ³ la partida!';
  else if(gs.phase==='done_hand') cb.textContent='Repartiendo nueva mano...';
  else if(gs.truco.state==='accepted') cb.textContent='âœ… '+TN[gs.truco.level]+' aceptado';
  else cb.textContent=isMt?'ğŸ´ Tu turno':'â³ Turno de '+opp.nick+'...';

  renderActs(gs,mr,or);
}

function mkSpot(played,lbl){
  var s=document.createElement('div'); s.className='pspot';
  if(played){s.style.border='none';s.appendChild(mkCard(played.card,false,false,true));}
  else s.textContent=lbl;
  return s;
}

function renderActs(gs,mr,or){
  var el=document.getElementById('acts'); el.innerHTML='';
  var ph=gs.phase, en=gs.envi, tr=gs.truco;
  if(ph==='done'&&gs.winner){
    if(myRole==='p1') addBtn(el,'ğŸ”„ Nueva partida','btn-gold',function(){doAction('NEW_GAME',{});});
    else addBtn(el,'Esperando nueva partida...','btn-gray',null,true);
    return;
  }
  if(ph==='done'||ph==='done_hand') return;
  if(ph==='envi_resp'){
    if(en.responder===mr){
      addBtn(el,'âœ… Quiero','btn-green',function(){doAction('RESP_ENVIDO',{r:'quiero'});});
      addBtn(el,'âŒ No Quiero','btn-red',function(){doAction('RESP_ENVIDO',{r:'no_quiero'});});
      if(en.level<4){
        if(en.level<2) addBtn(el,'Env+Env','btn-gray',function(){doAction('RESP_ENVIDO',{r:'raise',level:2});});
        if(en.level<3) addBtn(el,'Real Envido','btn-gray',function(){doAction('RESP_ENVIDO',{r:'raise',level:3});});
        addBtn(el,'Falta Envido','btn-gray',function(){doAction('RESP_ENVIDO',{r:'raise',level:4});});
      }
    } else addBtn(el,'Esperando respuesta...','btn-gray',null,true);
    return;
  }
  if(ph==='truco_resp'){
    if(tr.caller!==mr){
      addBtn(el,'âœ… Quiero','btn-green',function(){doAction('RESP_TRUCO',{r:'quiero'});});
      addBtn(el,'âŒ No Quiero','btn-red',function(){doAction('RESP_TRUCO',{r:'no_quiero'});});
      if(tr.level<3) addBtn(el,'â¬†ï¸ '+(tr.level===1?'Retruco':'Vale Cuatro'),'btn-gray',function(){doAction('RESP_TRUCO',{r:'raise'});});
    } else addBtn(el,'Esperando respuesta...','btn-gray',null,true);
    return;
  }
  var eRes=en.state==='accepted'||en.state==='rejected';
  if(!eRes&&gs.subRound===0){
    addBtn(el,'Envido','btn-gold',function(){doAction('CALL_ENVIDO',{level:1});});
    addBtn(el,'Real Envido','btn-gold',function(){doAction('CALL_ENVIDO',{level:3});});
    addBtn(el,'Falta Envido','btn-gold',function(){doAction('CALL_ENVIDO',{level:4});});
  }
  if(tr.state!=='rejected'){
    if(tr.state==='none') addBtn(el,'ğŸƒ Truco','btn-gold',function(){doAction('CALL_TRUCO',{});});
    else if(tr.state==='accepted'&&tr.caller!==mr&&tr.level<3) addBtn(el,'â¬†ï¸ '+(tr.level===1?'Retruco':'Vale Cuatro'),'btn-gray',function(){doAction('CALL_TRUCO',{});});
  }
  addBtn(el,'ğŸš¶ Ir al mazo','btn-red',function(){if(confirm('Â¿Seguro?'))doAction('MAZO',{});});
}

function mkCard(c,no,fd,sm){
  var el=document.createElement('div');
  if(fd||c.hidden){el.className='card fd';return el;}
  el.className='card '+SUITS[c.suit].name;
  if(sm) el.classList.add('sm');
  el.innerHTML='<div class="n">'+c.num+'</div><div class="s">'+SUITS[c.suit].sym+'</div>';
  return el;
}
function addBtn(c,l,cls,fn,dis){
  var b=document.createElement('button');
  b.className='btn '+cls; b.textContent=l;
  if(dis||!fn) b.disabled=true; else b.onclick=fn;
  c.appendChild(b);
}
function lg(msg,cls){
  var el=document.getElementById('log');
  var p=document.createElement('p');
  if(cls) p.classList.add(cls);
  p.textContent=msg; el.appendChild(p); el.scrollTop=el.scrollHeight;
}
function showScreen(id){
  document.querySelectorAll('.screen').forEach(function(s){s.classList.remove('active');});
  document.getElementById(id).classList.add('active');
}
function setSlot(i,nick,isMe){
  var el=document.getElementById('slot-'+i);
  if(nick){el.textContent='Jugador '+(i+1)+': '+nick+(isMe?' (vos)':'');el.classList.add('ok');}
  else{el.textContent='Jugador '+(i+1)+': esperando...';el.classList.remove('ok');}
}
function setSt(s,msg){
  var id=s==='home'?'home-st':'lobby-st';
  var el=document.getElementById(id);
  if(el) el.innerHTML=msg;
}
function copyCode(){
  navigator.clipboard.writeText(roomCode)
    .then(function(){toast('Â¡CÃ³digo copiado!');})
    .catch(function(){toast('CÃ³digo: '+roomCode);});
}
function toast(msg){
  var t=document.getElementById('toast');
  t.textContent=msg; t.style.display='block';
  setTimeout(function(){t.style.display='none';},2500);
}
</script>
</body>
</html>
